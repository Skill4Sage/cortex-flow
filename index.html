<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cortex Flow</title>
    <meta name="description" content="Allenamento cognitivo quotidiano">
    <meta name="theme-color" content="#0f172a">
    
    <!-- Meta tags per simulare App Nativa su Android/iOS -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Icona App -->
    <link rel="icon" type="image/png" href="https://img.icons8.com/fluency/96/brain.png">
    <link rel="apple-touch-icon" href="https://img.icons8.com/fluency/96/brain.png">

    <!-- Manifest integrato per installazione PWA -->
    <link rel="manifest" href='data:application/manifest+json,{"name":"Cortex Flow","short_name":"Cortex","start_url":".","display":"standalone","background_color":"#0f172a","theme_color":"#0f172a","icons":[{"src":"https://img.icons8.com/fluency/192/brain.png","sizes":"192x192","type":"image/png"}]}'>

    <!-- Librerie Core (React, Babel, Tailwind) -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: #e2e8f0;
            overscroll-behavior: none;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        /* Animazioni fluide */
        .animate-enter { animation: fadeIn 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .animate-pop { animation: popIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .animate-shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }

        .btn-press:active { transform: scale(0.96); transition: transform 0.1s; }

        /* Stili per la Casetta e Animazioni Persone */
        .house { position: relative; width: 140px; height: 100px; margin: 0 auto; margin-top: 60px; z-index: 10; }
        .roof { position: absolute; top: -50px; left: -10px; width: 0; height: 0; border-left: 80px solid transparent; border-right: 80px solid transparent; border-bottom: 50px solid #475569; }
        .walls { width: 100%; height: 100%; background: #1e293b; border: 4px solid #475569; position: relative; box-shadow: 0 10px 25px rgba(0,0,0,0.5); z-index: 10; }
        .door { width: 40px; height: 65px; background: #0f172a; bottom: 0; left: 50%; transform: translateX(-50%); position: absolute; border: 2px solid #334155; border-bottom: none; border-radius: 2px 2px 0 0; }
        
        /* Animazione Entrata: Da sinistra verso il centro (porta) */
        @keyframes walkIn { 
            0% { transform: translateX(-180px); opacity: 0; } 
            10% { opacity: 1; }
            80% { opacity: 1; transform: translateX(-10px) scale(0.95); }
            100% { transform: translateX(0) scale(0.8); opacity: 0; } 
        }
        
        /* Animazione Uscita: Dal centro (porta) verso destra */
        @keyframes walkOut { 
            0% { transform: translateX(0) scale(0.8); opacity: 0; } 
            20% { opacity: 1; transform: translateX(10px) scale(0.95); }
            90% { opacity: 1; }
            100% { transform: translateX(180px); opacity: 0; } 
        }

        .walker { position: absolute; bottom: 0; left: 50%; width: 32px; height: 32px; margin-left: -16px; z-index: 20; }
        /* Le classi anim-in/out sono applicate via JS con durata dinamica */

    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Wrapper per Icone Lucide ---
        const Icon = ({ name, size = 24, className = "", color = "currentColor" }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (window.lucide) {
                    window.lucide.createIcons({
                        root: iconRef.current?.parentNode,
                        nameAttr: 'data-lucide',
                        attrs: { class: className, width: size, height: size, stroke: color }
                    });
                }
            }, [name, size, className, color]);
            return <i ref={iconRef} data-lucide={name} className={className}></i>;
        };

        // --- Storage ---
        const useLocalStorage = (key, initialValue) => {
            const [storedValue, setStoredValue] = useState(() => {
                try {
                    const item = window.localStorage.getItem(key);
                    return item ? JSON.parse(item) : initialValue;
                } catch (error) { return initialValue; }
            });
            const setValue = (value) => {
                try {
                    const valueToStore = value instanceof Function ? value(storedValue) : value;
                    setStoredValue(valueToStore);
                    window.localStorage.setItem(key, JSON.stringify(valueToStore));
                } catch (error) {}
            };
            return [storedValue, setValue];
        };

        // --- Componenti UI ---
        const Card = ({ children, className = "" }) => (
            <div className={`bg-slate-800/80 backdrop-blur-md border border-slate-700/50 rounded-2xl p-6 shadow-xl ${className}`}>{children}</div>
        );

        const Button = ({ children, onClick, variant = "primary", className = "", disabled = false }) => {
            const base = "w-full py-4 rounded-xl font-bold text-lg flex items-center justify-center gap-2 btn-press disabled:opacity-50 disabled:cursor-not-allowed";
            const styles = {
                primary: "bg-indigo-600 text-white shadow-lg shadow-indigo-900/50",
                secondary: "bg-slate-700 text-white",
                outline: "border-2 border-slate-600 text-slate-300"
            };
            return <button onClick={onClick} disabled={disabled} className={`${base} ${styles[variant]} ${className}`}>{children}</button>;
        };

        // --- Gioco 1: Calcoli Rapidi ---
        const MathGame = ({ onComplete, difficulty }) => {
            const [q, setQ] = useState({ t: "", a: 0 });
            const [input, setInput] = useState("");
            const [count, setCount] = useState(1);
            const [score, setScore] = useState(0);
            const [status, setStatus] = useState("idle"); 
            
            const TOTAL_QUESTIONS = 20;

            useEffect(() => { gen(); }, []);

            const gen = () => {
                const ops = difficulty === 1 ? ['+','-'] : ['+','-','*'];
                const op = ops[Math.floor(Math.random()*ops.length)];
                let n1 = Math.floor(Math.random()*(difficulty*10))+5; 
                let n2 = Math.floor(Math.random()*10)+2;
                if(op === '-') [n1,n2] = [Math.max(n1,n2), Math.min(n1,n2)];
                setQ({ t: `${n1} ${op} ${n2}`, a: op==='+'?n1+n2 : op==='-'?n1-n2 : n1*n2 });
            };

            const check = () => {
                if (status !== "idle") return;
                if(parseInt(input) === q.a) { 
                    setStatus("correct");
                    setTimeout(() => {
                        const newScore = score + (10 * difficulty);
                        setScore(newScore);
                        if (count >= TOTAL_QUESTIONS) onComplete(newScore);
                        else { setCount(c => c + 1); setInput(""); setStatus("idle"); gen(); }
                    }, 500);
                } else { 
                    setStatus("error");
                    setTimeout(() => { setInput(""); setStatus("idle"); }, 600);
                } 
            };

            const cardClass = status === "correct" ? "border-green-500 bg-green-900/20" : status === "error" ? "border-red-500 bg-red-900/20 animate-shake" : "";
            const inputColor = status === "correct" ? "text-green-400" : status === "error" ? "text-red-400" : "text-indigo-400";

            return (
                <div className="flex flex-col h-full animate-enter">
                    <div className="flex justify-between text-slate-400 font-mono mb-4 text-sm font-bold"><span>DOMANDA: {count}/{TOTAL_QUESTIONS}</span><span className="text-indigo-400">PUNTI: {score}</span></div>
                    <Card className={`mb-6 flex-grow flex flex-col items-center justify-center transition-all duration-300 ${cardClass}`}>
                        <div className="text-6xl font-bold mb-6">{q.t}</div>
                        <div className={`text-4xl h-10 font-bold transition-colors ${inputColor}`}>{input}_</div>
                        {status === "error" && <div className="mt-4 text-red-400 font-bold text-sm animate-pulse">Riprova!</div>}
                    </Card>
                    <div className="grid grid-cols-3 gap-3">
                        {[1,2,3,4,5,6,7,8,9].map(n=><button key={n} onClick={()=>setInput(i=>i+n)} className="bg-slate-700 p-4 rounded-xl text-2xl font-bold btn-press">{n}</button>)}
                        <button onClick={()=>setInput("")} className="bg-red-900/30 text-red-400 p-4 rounded-xl font-bold btn-press">C</button>
                        <button onClick={()=>setInput(i=>i+"0")} className="bg-slate-700 p-4 rounded-xl text-2xl font-bold btn-press">0</button>
                        <button onClick={check} className="bg-green-600 text-white p-4 rounded-xl font-bold btn-press shadow-lg shadow-green-900/50">OK</button>
                    </div>
                </div>
            );
        };

        // --- Gioco 2: Synapse Sequence ---
        const MemoryGame = ({ onComplete, difficulty }) => {
            const icons = ['zap', 'heart', 'star', 'moon', 'sun', 'music', 'anchor', 'cloud'];
            const [seq, setSeq] = useState([]);
            const [playSeq, setPlaySeq] = useState([]);
            const [show, setShow] = useState(false);
            const [lvl, setLvl] = useState(1);
            const [msg, setMsg] = useState("Osserva");

            useEffect(() => start(1), []);

            const start = (l) => {
                setPlaySeq([]);
                const s = Array(l+2).fill(0).map(()=>icons[Math.floor(Math.random()*icons.length)]);
                setSeq(s); setShow(true); setMsg("Memorizza!");
                setTimeout(() => { setShow(false); setMsg("Ripeti!"); }, 1500 + (l*500));
            };

            const tap = (ic) => {
                if(show) return;
                if(ic !== seq[playSeq.length]) { onComplete((lvl-1)*50); return; }
                const np = [...playSeq, ic];
                setPlaySeq(np);
                if(np.length === seq.length) {
                    if(lvl >= difficulty+2) onComplete(lvl*100);
                    else { setLvl(l=>l+1); setTimeout(()=>start(lvl+1), 500); }
                }
            };

            return (
                <div className="flex flex-col h-full animate-enter">
                    <div className="text-center text-slate-400 mb-4">Livello {lvl}</div>
                    <div className="flex-grow flex flex-col items-center justify-center">
                        {show ? <div className="flex gap-3 flex-wrap justify-center animate-pop">{seq.map((ic,i)=><div key={i} className="bg-indigo-900/50 p-3 rounded"><Icon name={ic} size={32} color="#818cf8"/></div>)}</div>
                        : <div className="text-2xl font-bold text-slate-300 animate-pulse">{msg}</div>}
                    </div>
                    <div className="grid grid-cols-4 gap-3 mt-auto">
                        {icons.map(ic=><button key={ic} disabled={show} onClick={()=>tap(ic)} className="bg-slate-700 p-3 rounded-xl flex justify-center items-center btn-press disabled:opacity-30"><Icon name={ic} size={28}/></button>)}
                    </div>
                </div>
            );
        };

        // --- Gioco 3: Cortex House (Corretto e Ottimizzato) ---
        const LogicGame = ({ onComplete, difficulty }) => {
            const [stage, setStage] = useState('watch');
            const [round, setRound] = useState(1);
            const [score, setScore] = useState(0);
            const [peopleInside, setPeopleInside] = useState(0);
            const [userAnswer, setUserAnswer] = useState("");
            const [people, setPeople] = useState([]);
            const [status, setStatus] = useState("idle");

            const TOTAL_ROUNDS = 5;

            useEffect(() => { startRound(); }, []);

            const startRound = () => {
                setStage('watch');
                setUserAnswer("");
                setStatus("idle");
                setPeople([]);
                
                let curr = 0;
                let events = [];
                const count = 3 + (difficulty * 2);
                
                for(let i=0; i<count; i++) {
                    const enter = Math.random() > 0.4 || curr === 0;
                    const val = Math.floor(Math.random() * 3) + 1;
                    if(enter){ curr += val; events.push({t:'in', v:val}); } 
                    else { const r = Math.min(curr, val); curr -= r; events.push({t:'out', v:r}); }
                }
                setPeopleInside(curr);

                let i = 0;
                // Velocità animazione basata sulla difficoltà: più difficile = più veloce
                const speedMs = Math.max(800, 2000 - (difficulty * 200)); 
                
                const int = setInterval(() => {
                    if (i >= events.length) {
                        clearInterval(int);
                        setTimeout(() => setStage('answer'), speedMs + 500); 
                        return;
                    }
                    
                    const ev = events[i];
                    const newBatch = [];
                    for(let p=0; p<ev.v; p++) {
                        newBatch.push({
                            id: `p-${round}-${i}-${p}`,
                            type: ev.t,
                            gender: Math.random() > 0.5 ? 'm' : 'f',
                            delay: p * 0.2,
                            duration: speedMs / 1000 // Durata in secondi per CSS
                        });
                    }
                    setPeople(newBatch);
                    // Puliamo l'array prima che arrivi il prossimo gruppo per evitare sovrapposizioni
                    setTimeout(() => setPeople([]), speedMs - 50);
                    i++;
                }, speedMs);
            };

            const submit = () => {
                if (status !== 'idle') return;

                const isCorrect = parseInt(userAnswer) === peopleInside;
                setStatus(isCorrect ? 'correct' : 'error');

                setTimeout(() => {
                    let newTotalScore = score;
                    if (isCorrect) newTotalScore += (100 * difficulty);
                    
                    if (round < TOTAL_ROUNDS) {
                        setScore(newTotalScore);
                        setRound(r => r + 1);
                        startRound();
                    } else {
                        onComplete(newTotalScore);
                    }
                }, 1500); // Tempo per vedere il feedback
            };

            const cardClass = status === "correct" ? "border-green-500 bg-green-900/20" : 
                              status === "error" ? "border-red-500 bg-red-900/20 animate-shake" : "";
            const textClass = status === "correct" ? "text-green-400" : 
                              status === "error" ? "text-red-400" : "text-indigo-400";

            if(stage === 'watch') return (
                <div className="flex flex-col items-center justify-center h-full animate-enter relative overflow-hidden">
                    <div className="flex justify-between w-full mb-4 px-2 font-bold text-slate-400 text-sm">
                        <span>ROUND {round}/{TOTAL_ROUNDS}</span>
                        <span className="text-indigo-400">PUNTI: {score}</span>
                    </div>
                    <div className="text-xl font-bold text-slate-300 mb-8 absolute top-16">Osserva la casa...</div>
                    <div className="house">
                        <div className="roof"></div>
                        <div className="walls"><div className="door"></div></div>
                    </div>
                    <div className="absolute inset-0 pointer-events-none">
                        {people.map((p) => (
                            <div 
                                key={p.id} 
                                className="walker" 
                                style={{ 
                                    animation: `${p.type === 'in' ? 'walkIn' : 'walkOut'} ${p.duration}s linear forwards`,
                                    animationDelay: `${p.delay}s`
                                }}
                            >
                                <Icon name="user" size={32} color={p.gender === 'm' ? '#22d3ee' : '#e879f9'} className="drop-shadow-lg" />
                            </div>
                        ))}
                    </div>
                </div>
            );

            return (
                <div className="flex flex-col h-full animate-enter">
                    <div className="flex justify-between w-full mb-4 px-2 font-bold text-slate-400 text-sm">
                        <span>ROUND {round}/{TOTAL_ROUNDS}</span>
                        <span className="text-indigo-400">PUNTI: {score}</span>
                    </div>
                    <h2 className="text-center text-xl mb-6 font-bold text-slate-200">Quante persone sono rimaste?</h2>
                    <Card className={`mb-8 flex flex-col items-center justify-center transition-all duration-300 ${cardClass}`}>
                        <div className={`text-6xl font-bold min-h-[4rem] transition-colors ${textClass}`}>{userAnswer}_</div>
                        {status === "error" && <div className="text-red-400 font-bold text-sm animate-pulse mt-2">Sbagliato! Erano {peopleInside}</div>}
                        {status === "correct" && <div className="text-green-400 font-bold text-sm animate-pulse mt-2">Corretto!</div>}
                    </Card>
                    <div className="grid grid-cols-3 gap-3 mt-auto">
                        {[1,2,3,4,5,6,7,8,9,0].map(n=><button key={n} onClick={()=>setUserAnswer(a=>a+n)} className="bg-slate-700 p-4 rounded-xl text-2xl font-bold btn-press">{n}</button>)}
                        <button onClick={()=>setUserAnswer("")} className="bg-red-900/30 text-red-400 p-4 rounded-xl font-bold btn-press">C</button>
                        <button onClick={submit} className="bg-green-600 text-white p-4 rounded-xl font-bold col-span-3 shadow-lg shadow-green-900/50 btn-press">CONFERMA</button>
                    </div>
                </div>
            );
        };

        // --- App ---
        const App = () => {
            const [user, setUser] = useLocalStorage('cortex_user', {xp:0, level:1, streak:0, last:null});
            const [view, setView] = useState('home');
            const [game, setGame] = useState(null);
            const [queue, setQueue] = useState([]);
            const [sXp, setSXp] = useState(0);

            useEffect(() => {
                const t = new Date().toDateString();
                if(user.last && user.last !== t) {
                    const y = new Date(); y.setDate(y.getDate()-1);
                    if(user.last !== y.toDateString()) setUser({...user, streak:0});
                }
            }, []);

            const next = (xp) => {
                const nx = sXp + xp; setSXp(nx);
                const rem = queue.slice(1);
                if(rem.length>0) { setQueue(rem); setGame(rem[0]); }
                else {
                    const t = new Date().toDateString();
                    const b = user.last !== t ? 1 : 0;
                    const fx = user.xp + nx;
                    setUser({...user, xp:fx, level:Math.floor(fx/1000)+1, streak:user.streak+b, last:t});
                    setView('reward');
                }
            };

            const Reward = () => {
                const cvs = useRef(null);
                useEffect(()=>{
                    const ctx = cvs.current.getContext('2d');
                    ctx.fillStyle='#1e293b'; ctx.fillRect(0,0,300,300);
                    for(let i=0; i<20; i++){
                        ctx.beginPath(); ctx.strokeStyle=`hsl(${Math.random()*360},70%,60%)`;
                        ctx.moveTo(Math.random()*300, Math.random()*300);
                        ctx.lineTo(Math.random()*300, Math.random()*300);
                        ctx.stroke();
                    }
                },[]);
                return (
                    <div className="flex flex-col items-center justify-center h-full animate-enter p-6">
                        <h2 className="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-purple-400 mb-4">Ottimo!</h2>
                        <div className="text-slate-400 mb-6">+{sXp} XP</div>
                        <canvas ref={cvs} width="300" height="300" className="rounded-xl shadow-2xl mb-6 bg-slate-800"></canvas>
                        <button onClick={()=>setView('home')} className="bg-indigo-600 text-white py-4 px-8 rounded-xl font-bold shadow-lg shadow-indigo-900/50">Home</button>
                    </div>
                );
            };

            return (
                <div className="max-w-md mx-auto min-h-screen p-4 flex flex-col">
                    {view==='home' && (
                        <div className="animate-enter space-y-6">
                            <div className="flex justify-between items-end mt-4">
                                <div><h1 className="text-3xl font-black">Cortex<span className="text-indigo-500">Flow</span></h1><p className="text-slate-400 text-sm">Liv. {user.level} • {user.xp} XP</p></div>
                                <div className="text-center"><div className="text-2xl font-bold text-yellow-500 flex items-center gap-1"><Icon name="flame" size={24} color="#eab308"/>{user.streak}</div><div className="text-[10px] uppercase text-slate-500 font-bold">Streak</div></div>
                            </div>
                            <Card><div className="text-sm font-bold text-slate-400 mb-2">PROGRESSO</div><div className="h-3 bg-slate-900 rounded-full overflow-hidden"><div className="h-full bg-indigo-500 transition-all duration-1000" style={{width: `${(user.xp%1000)/10}%`}}></div></div></Card>
                            <button onClick={()=>{setQueue(['math','mem','logic']); setSXp(0); setGame('math'); setView('game');}} className="w-full bg-gradient-to-r from-indigo-600 to-purple-600 p-6 rounded-2xl flex items-center justify-between shadow-lg btn-press">
                                <div className="text-left"><div className="text-xl font-bold text-white flex gap-2"><Icon name="dumbbell" className="text-white"/> Daily Workout</div><div className="text-indigo-200 text-sm mt-1">5 Minuti</div></div>
                                <div className="bg-white/20 p-3 rounded-full"><Icon name="play" color="white"/></div>
                            </button>
                            <div className="grid grid-cols-2 gap-3">
                                {[{id:'math',n:'Calcoli Rapidi',i:'calculator',c:'text-cyan-400'},{id:'mem',n:'Synapse Seq',i:'grid',c:'text-purple-400'},{id:'logic',n:'Cortex House',i:'home',c:'text-orange-400'}].map(g=>
                                    <button key={g.id} onClick={()=>{setQueue([]); setGame(g.id); setView('game');}} className="bg-slate-800 border border-slate-700 p-4 rounded-xl text-left btn-press"><Icon name={g.i} className={`mb-3 ${g.c}`}/><div className="font-bold text-sm">{g.n}</div></button>
                                )}
                            </div>
                        </div>
                    )}
                    {view==='game' && (
                        <div className="flex-grow flex flex-col">
                            <div className="flex items-center mb-4"><button onClick={()=>setView('home')} className="p-2"><Icon name="arrow-left"/></button><span className="font-bold text-indigo-400 ml-2 uppercase text-sm tracking-wider">{game === 'math' ? 'Calcoli Rapidi' : game}</span></div>
                            {game==='math' && <MathGame difficulty={Math.ceil(user.level/5)} onComplete={next}/>}
                            {game==='mem' && <MemoryGame difficulty={Math.ceil(user.level/5)} onComplete={next}/>}
                            {game==='logic' && <LogicGame difficulty={Math.ceil(user.level/5)} onComplete={next}/>}
                        </div>
                    )}
                    {view==='reward' && <Reward/>}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
