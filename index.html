<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cortex Flow</title>
    <meta name="description" content="Allenamento cognitivo quotidiano">
    <meta name="theme-color" content="#0f172a">
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="icon" type="image/png" href="https://img.icons8.com/fluency/96/brain.png">
    <link rel="apple-touch-icon" href="https://img.icons8.com/fluency/96/brain.png">
    <link rel="manifest" href='data:application/manifest+json,{"name":"Cortex Flow","short_name":"Cortex","start_url":".","display":"standalone","background_color":"#0f172a","theme_color":"#0f172a","icons":[{"src":"https://img.icons8.com/fluency/192/brain.png","sizes":"192x192","type":"image/png"}]}'>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: #e2e8f0;
            overscroll-behavior: none;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .animate-enter { animation: fadeIn 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .animate-pop { animation: popIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .animate-shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }

        .btn-press:active { transform: scale(0.96); transition: transform 0.1s; }

        /* --- HOUSE OF CORTEX STYLES (CORRETTO PROFONDITÀ) --- */
        .game-scene { position: relative; width: 100%; height: 220px; overflow: hidden; display: flex; justify-content: center; align-items: flex-end; }
        
        /* La casa deve coprire chi è dentro, ma la porta deve mostrare lo sfondo (nero) */
        .house-container { position: relative; z-index: 20; display: flex; justify-content: center; align-items: flex-end; }
        .house-roof { position: absolute; top: -50px; border-left: 80px solid transparent; border-right: 80px solid transparent; border-bottom: 50px solid #64748b; }
        .house-body { 
            width: 140px; height: 120px; 
            background: #f8fafc; 
            border: 4px solid #64748b; 
            position: relative; 
            display: flex; justify-content: center; align-items: flex-end; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
        }
        .house-door { 
            width: 50px; height: 80px; 
            background: #1e293b; /* Colore "interno" scuro */
            border-radius: 4px 4px 0 0; 
            position: relative;
            z-index: 5; /* La porta è dietro al muro ma davanti allo sfondo */
        }

        .stick-figure { 
            position: absolute; bottom: 0; left: 50%; margin-left: -15px; 
            width: 30px; height: 60px; 
            display: flex; flex-direction: column; align-items: center; 
            opacity: 0; 
            /* Z-index gestito dalle animazioni */
        }
        .head { width: 14px; height: 14px; border-radius: 50%; margin-bottom: 2px; border: 2px solid white; }
        .body { width: 4px; height: 20px; background: white; border-radius: 2px; }
        .legs { width: 20px; height: 20px; border-top: 2px solid white; border-radius: 50% 50% 0 0; margin-top: -2px; }
        
        /* Entrata: Parte DAVANTI (z30), arriva alla porta, passa DIETRO (z10) */
        @keyframes walkIn { 
            0% { transform: translateX(-180px); opacity: 1; z-index: 30; } 
            60% { transform: translateX(-20px); opacity: 1; z-index: 30; }
            61% { z-index: 10; } /* Switch layer sulla soglia */
            100% { transform: translateX(0) scale(0.8); opacity: 0; z-index: 10; } 
        }
        
        /* Uscita: Parte DIETRO (z10), arriva alla porta, passa DAVANTI (z30) */
        @keyframes walkOut { 
            0% { transform: translateX(0) scale(0.8); opacity: 0; z-index: 10; } 
            39% { z-index: 10; }
            40% { transform: translateX(10px) scale(0.9); opacity: 1; z-index: 30; } 
            100% { transform: translateX(180px); opacity: 0; z-index: 30; } 
        }
        
        .anim-in { animation: walkIn 1.5s linear forwards; }
        .anim-out { animation: walkOut 1.5s linear forwards; }

        /* --- DIGIT RUNNER STYLES (CORRETTO STOP & FALL) --- */
        .runner-scene { position: relative; width: 100%; height: 240px; overflow: hidden; background: #1e293b; border-radius: 12px; border-bottom: 4px solid #475569; }
        .track { position: absolute; bottom: 0; width: 100%; height: 4px; background: #94a3b8; z-index: 5; }
        
        .runner-box { position: absolute; bottom: 4px; left: 60px; width: 40px; height: 70px; z-index: 20; transition: transform 0.2s; }
        .stick-head { width: 16px; height: 16px; background: #38bdf8; border-radius: 50%; position: absolute; top: 0; left: 12px; z-index: 2; border: 2px solid #0c4a6e; }
        .stick-torso { width: 6px; height: 32px; background: white; position: absolute; top: 16px; left: 17px; z-index: 1; border-radius: 3px; }
        .stick-limb { width: 6px; height: 24px; background: white; position: absolute; transform-origin: top center; border-radius: 3px; }
        
        .arm-l { top: 18px; left: 17px; background: #cbd5e1; z-index: 0; }
        .arm-r { top: 18px; left: 17px; z-index: 3; }
        .leg-l { top: 44px; left: 17px; background: #cbd5e1; z-index: 0; }
        .leg-r { top: 44px; left: 17px; z-index: 3; }

        /* Animazioni Arti */
        @keyframes swing { from { transform: rotate(40deg); } to { transform: rotate(-40deg); } }
        @keyframes run { from { transform: rotate(35deg); } to { transform: rotate(-35deg); } }

        /* Stati Omino */
        .runner-box.running .arm-l, .runner-box.running .arm-r { animation: swing 0.5s infinite alternate; }
        .runner-box.running .leg-l, .runner-box.running .leg-r { animation: run 0.5s infinite alternate; }
        
        .runner-box.waiting .stick-limb { animation: none; transform: rotate(0); } /* Fermo in attesa */
        
        .runner-box.jumping { animation: jumpHigh 0.5s ease-in-out; }
        .runner-box.jumping .stick-limb { animation: none; }
        .runner-box.jumping .leg-l { transform: rotate(45deg); }
        .runner-box.jumping .leg-r { transform: rotate(-45deg); }

        .runner-box.stumbling { transform-origin: bottom center; animation: fallFlat 0.3s forwards; }
        /* Blocca arti quando cade */
        .runner-box.stumbling .stick-limb { animation: none !important; transform: rotate(0) !important; }

        @keyframes jumpHigh { 
            0% { bottom: 4px; } 50% { bottom: 130px; } 100% { bottom: 4px; } 
        }
        @keyframes fallFlat {
            0% { transform: rotate(0); } 100% { transform: rotate(90deg) translateY(20px); }
        }

        /* Ostacolo */
        .hurdle-group { 
            position: absolute; bottom: 4px; 
            display: flex; flex-direction: column; align-items: center; justify-content: flex-end;
            /* La transizione è gestita via JS/CSS classi per stop preciso */
        }
        .hurdle-wall { width: 16px; height: 80px; background: #ef4444; border: 2px solid #b91c1c; border-radius: 4px; }
        .hurdle-nums { display: flex; gap: 12px; margin-bottom: 8px; }
        
        .hurdle-moving { transition: right 1s linear; } /* Scorre verso sx */
        .hurdle-leaving { transition: right 0.5s linear; } /* Scorre via veloce */

    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const Icon = ({ name, size = 24, className = "", color = "currentColor" }) => {
            const iconRef = useRef(null);
            useEffect(() => { if (window.lucide) window.lucide.createIcons({ root: iconRef.current?.parentNode, nameAttr: 'data-lucide', attrs: { class: className, width: size, height: size, stroke: color } }); }, [name, size, className, color]);
            return <i ref={iconRef} data-lucide={name} className={className}></i>;
        };

        const useLocalStorage = (key, initialValue) => {
            const [storedValue, setStoredValue] = useState(() => {
                try { return JSON.parse(window.localStorage.getItem(key)) || initialValue; } catch { return initialValue; }
            });
            const setValue = (value) => {
                try {
                    const valueToStore = value instanceof Function ? value(storedValue) : value;
                    setStoredValue(valueToStore);
                    window.localStorage.setItem(key, JSON.stringify(valueToStore));
                } catch {}
            };
            return [storedValue, setValue];
        };

        const Card = ({ children, className = "" }) => <div className={`bg-slate-800/80 backdrop-blur-md border border-slate-700/50 rounded-2xl p-6 shadow-xl ${className}`}>{children}</div>;
        const Button = ({ children, onClick, variant = "primary", className = "", disabled = false }) => {
            const styles = { primary: "bg-indigo-600 text-white shadow-lg", secondary: "bg-slate-700 text-white", outline: "border-2 border-slate-600 text-slate-300" };
            return <button onClick={onClick} disabled={disabled} className={`w-full py-4 rounded-xl font-bold text-lg flex items-center justify-center gap-2 btn-press disabled:opacity-50 ${styles[variant]} ${className}`}>{children}</button>;
        };

        // --- GIOCO 1: CALCOLI RAPIDI ---
        const MathGame = ({ onComplete, difficulty }) => {
            const [q, setQ] = useState({ t: "", a: 0 });
            const [input, setInput] = useState("");
            const [count, setCount] = useState(1);
            const [score, setScore] = useState(0);
            const [status, setStatus] = useState("idle");
            const TOTAL = 20;

            useEffect(() => gen(), []);

            const gen = () => {
                const ops = ['+', '-', '×', '÷'];
                const op = ops[Math.floor(Math.random() * ops.length)];
                let n1, n2, ans;
                if (op === '+') { n1=Math.floor(Math.random()*(difficulty*10))+5; n2=Math.floor(Math.random()*10)+2; ans=n1+n2; }
                else if (op === '-') { n1=Math.floor(Math.random()*(difficulty*10))+5; n2=Math.floor(Math.random()*10)+2; if(n1<n2)[n1,n2]=[n2,n1]; ans=n1-n2; }
                else if (op === '×') { n1=Math.floor(Math.random()*11); n2=Math.floor(Math.random()*11); ans=n1*n2; }
                else if (op === '÷') { n2=Math.floor(Math.random()*10)+1; ans=Math.floor(Math.random()*11); n1=n2*ans; }
                setQ({ t: `${n1} ${op} ${n2}`, a: ans });
            };

            const check = () => {
                if(status !== 'idle') return;
                if(parseInt(input)===q.a) {
                    setStatus('correct');
                    setTimeout(() => {
                        const ns = score + (10*difficulty); setScore(ns);
                        if(count>=TOTAL) onComplete(ns); else { setCount(c=>c+1); setInput(""); setStatus('idle'); gen(); }
                    }, 500);
                } else {
                    setStatus('error');
                    setTimeout(() => { setInput(""); setStatus('idle'); }, 600);
                }
            };

            return (
                <div className="flex flex-col h-full animate-enter">
                    <div className="flex justify-between text-slate-400 font-mono text-sm font-bold mb-4"><span>DOMANDA: {count}/{TOTAL}</span><span className="text-indigo-400">PUNTI: {score}</span></div>
                    <Card className={`mb-6 flex-grow flex flex-col items-center justify-center transition-all ${status==='correct'?'border-green-500 bg-green-900/20':status==='error'?'border-red-500 bg-red-900/20 animate-shake':''}`}>
                        <div className="text-6xl font-bold mb-6">{q.t}</div>
                        <div className={`text-4xl h-10 font-bold ${status==='correct'?'text-green-400':status==='error'?'text-red-400':'text-indigo-400'}`}>{input}</div>
                    </Card>
                    <div className="grid grid-cols-3 gap-3">
                        {[1,2,3,4,5,6,7,8,9].map(n=><button key={n} onClick={()=>setInput(i=>i+n)} className="bg-slate-700 p-4 rounded-xl text-2xl font-bold btn-press">{n}</button>)}
                        <button onClick={()=>setInput("")} className="bg-red-900/30 text-red-400 p-4 rounded-xl font-bold btn-press">C</button>
                        <button onClick={()=>setInput(i=>i+"0")} className="bg-slate-700 p-4 rounded-xl text-2xl font-bold btn-press">0</button>
                        <button onClick={check} className="bg-green-600 text-white p-4 rounded-xl font-bold btn-press shadow-lg">OK</button>
                    </div>
                </div>
            );
        };

        // --- GIOCO 2: SYNAPSE SEQUENCE ---
        const MemoryGame = ({ onComplete, difficulty }) => {
            const icons = ['zap', 'heart', 'star', 'moon', 'sun', 'music', 'anchor', 'cloud'];
            const [seq, setSeq] = useState([]);
            const [playSeq, setPlaySeq] = useState([]);
            const [show, setShow] = useState(false);
            const [lvl, setLvl] = useState(1);
            const [msg, setMsg] = useState("Osserva");

            useEffect(() => start(1), []);

            const start = (l) => {
                setPlaySeq([]);
                const s = Array(l+2).fill(0).map(()=>icons[Math.floor(Math.random()*icons.length)]);
                setSeq(s); setShow(true); setMsg("Memorizza!");
                setTimeout(() => { setShow(false); setMsg("Ripeti!"); }, 1500 + (l*500));
            };

            const tap = (ic) => {
                if(show) return;
                if(ic !== seq[playSeq.length]) { onComplete((lvl-1)*50); return; }
                const np = [...playSeq, ic]; setPlaySeq(np);
                if(np.length === seq.length) {
                    if(lvl >= difficulty+2) onComplete(lvl*100); else { setLvl(l=>l+1); setTimeout(()=>start(lvl+1), 500); }
                }
            };

            return (
                <div className="flex flex-col h-full animate-enter">
                    <div className="text-center text-slate-400 mb-4">Livello {lvl}</div>
                    <div className="flex-grow flex flex-col items-center justify-center">
                        {show ? <div className="flex gap-3 flex-wrap justify-center animate-pop">{seq.map((ic,i)=><div key={i} className="bg-indigo-900/50 p-3 rounded"><Icon name={ic} size={32} color="#818cf8"/></div>)}</div> : <div className="text-2xl font-bold text-slate-300 animate-pulse">{msg}</div>}
                    </div>
                    <div className="grid grid-cols-4 gap-3 mt-auto">
                        {icons.map(ic=><button key={ic} disabled={show} onClick={()=>tap(ic)} className="bg-slate-700 p-3 rounded-xl flex justify-center items-center btn-press disabled:opacity-30"><Icon name={ic} size={28}/></button>)}
                    </div>
                </div>
            );
        };

        // --- GIOCO 3: HOUSE OF CORTEX ---
        const LogicGame = ({ onComplete, difficulty }) => {
            const [phase, setPhase] = useState('intro');
            const [round, setRound] = useState(1);
            const [totalScore, setTotalScore] = useState(0);
            const [peopleInside, setPeopleInside] = useState(0);
            const [userAns, setUserAns] = useState("");
            const [queue, setQueue] = useState([]);
            const [feedback, setFeedback] = useState(null);

            const MAX_ROUNDS = 5;

            useEffect(() => { setTimeout(() => startRound(1), 500); }, []);

            const startRound = (currentRound) => {
                setPhase('watching');
                setUserAns("");
                setFeedback(null);
                setQueue([]);

                let current = 0;
                let events = []; 
                const numEvents = 3 + (currentRound > 1 ? difficulty : 0);

                let timeOffset = 500;
                const batchTime = 2000;

                for(let i=0; i<numEvents; i++) {
                    const isEnter = Math.random() > 0.4 || current === 0;
                    const count = Math.floor(Math.random() * 3) + 1;
                    if(isEnter) {
                        current += count;
                        for(let k=0; k<count; k++) events.push({ id: `r${currentRound}-e${i}-p${k}`, type: 'in', delay: timeOffset + (k*200), gender: Math.random()>0.5?'m':'f' });
                    } else {
                        const realExit = Math.min(current, count);
                        current -= realExit;
                        for(let k=0; k<realExit; k++) events.push({ id: `r${currentRound}-e${i}-p${k}`, type: 'out', delay: timeOffset + (k*200), gender: Math.random()>0.5?'m':'f' });
                    }
                    timeOffset += batchTime;
                }
                setPeopleInside(current);
                setQueue(events);
                setTimeout(() => setPhase('guessing'), timeOffset + 1500);
            };

            const submit = () => {
                if(phase !== 'guessing') return;
                const val = parseInt(userAns);
                const isCorrect = val === peopleInside;
                setFeedback({ correct: isCorrect, val: peopleInside });
                setPhase('feedback');
                let newScore = totalScore;
                if(isCorrect) newScore += (100 * difficulty);
                setTimeout(() => {
                    if(round < MAX_ROUNDS) { setTotalScore(newScore); setRound(r => r + 1); startRound(round + 1); } 
                    else { onComplete(newScore); }
                }, 2500);
            };

            const Person = ({ p }) => {
                const color = p.gender === 'm' ? '#0ea5e9' : '#d946ef';
                return (
                    <div className={`stick-figure ${p.type === 'in' ? 'anim-in' : 'anim-out'}`} style={{ animationDelay: `${p.delay}ms` }}>
                        <div className="head" style={{ borderColor: color }}></div>
                        <div className="body" style={{ backgroundColor: color }}></div>
                        <div className="legs" style={{ borderTopColor: color }}></div>
                    </div>
                );
            };

            return (
                <div className="flex flex-col h-full animate-enter">
                    <div className="flex justify-between text-slate-400 font-mono text-sm font-bold mb-2"><span>ROUND: {round}/{MAX_ROUNDS}</span><span className="text-indigo-400">PUNTI: {totalScore}</span></div>
                    {phase === 'watching' && (
                        <div className="flex-grow flex flex-col relative overflow-hidden bg-slate-900 rounded-xl border border-slate-800 mb-4">
                            <div className="absolute top-4 w-full text-center z-50"><span className="text-white font-bold bg-black/50 px-4 py-1 rounded-full">Osserva...</span></div>
                            <div className="game-scene">
                                <div className="house-container">
                                    <div className="house"><div className="house-roof"></div><div className="house-body"><div className="house-door"></div></div></div>
                                    {queue.map(p => <Person key={p.id} p={p} />)}
                                </div>
                                <div className="absolute bottom-0 w-full h-2 bg-slate-700 z-0"></div>
                            </div>
                        </div>
                    )}
                    {(phase === 'guessing' || phase === 'feedback') && (
                        <div className="flex-grow flex flex-col items-center justify-center animate-pop">
                            <h2 className="text-xl font-bold text-white mb-6">Quanti dentro?</h2>
                            <Card className={`mb-6 w-full flex flex-col items-center transition-colors ${phase==='feedback' ? (feedback.correct ? 'border-green-500 bg-green-900/20' : 'border-red-500 bg-red-900/20') : ''}`}>
                                <div className={`text-6xl font-bold h-16 ${phase==='feedback' ? (feedback.correct ? 'text-green-400' : 'text-red-400') : 'text-indigo-400'}`}>{userAns}</div>
                                {phase === 'feedback' && (<div className="mt-2 font-bold text-lg animate-pop">{feedback.correct ? "Corretto!" : `No! Erano ${feedback.val}`}</div>)}
                            </Card>
                            {phase === 'guessing' && (
                                <div className="grid grid-cols-3 gap-3 w-full">
                                    {[1,2,3,4,5,6,7,8,9,0].map(n => <button key={n} onClick={()=>setUserAns(s=>s+n)} className="bg-slate-700 p-4 rounded-xl text-2xl font-bold btn-press text-white">{n}</button>)}
                                    <button onClick={()=>setUserAns("")} className="bg-red-900/30 text-red-400 p-4 rounded-xl font-bold btn-press">C</button>
                                    <button onClick={submit} className="bg-green-600 text-white p-4 rounded-xl font-bold col-span-2 shadow-lg btn-press">CONFERMA</button>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        // --- GIOCO 4: DIGIT RUNNER (CORRETTO STOP & FALL) ---
        const RunnerGame = ({ onComplete, difficulty }) => {
            const [phase, setPhase] = useState('approach'); // approach, decision, result
            const [count, setCount] = useState(1);
            const [score, setScore] = useState(0);
            const [options, setOptions] = useState([]);
            const [anim, setAnim] = useState('running');
            const [hurdlePos, setHurdlePos] = useState(-150); // posiz css
            const [timerW, setTimerW] = useState(100);
            
            const TOTAL = 15;
            const timerRef = useRef(null);

            useEffect(() => {
                spawnObstacle();
                return () => clearInterval(timerRef.current);
            }, []);

            const spawnObstacle = () => {
                setAnim('running');
                setPhase('approach');
                setHurdlePos(-150); // Fuori destra
                setTimerW(100);

                // Genera Numeri
                const n1 = Math.floor(Math.random()*20)+1;
                let n2 = Math.floor(Math.random()*20)+1;
                while(n2===n1) n2=Math.floor(Math.random()*20)+1;
                const nums = [n1, n2];
                if(difficulty > 1) {
                    let n3 = Math.floor(Math.random()*20)+1;
                    while(n3===n1 || n3===n2) n3=Math.floor(Math.random()*20)+1;
                    nums.push(n3);
                }
                setOptions(nums.sort(()=>Math.random()-0.5));

                // 1. Corsa verso l'ostacolo
                // Usiamo un timeout per simulare l'arrivo dell'ostacolo
                setTimeout(() => {
                    setHurdlePos(120); // Posizione davanti all'omino
                    setPhase('decision');
                    setAnim('waiting'); // Stop corsa
                    startDecisionTimer();
                }, 1000); // Tempo di avvicinamento
            };

            const startDecisionTimer = () => {
                let w = 100;
                const step = 6.7; // 15 passi circa per 1.5s (calibrato per gameplay fluido)
                const interval = setInterval(() => {
                    w -= step;
                    setTimerW(w);
                    if(w <= 0) {
                        clearInterval(interval);
                        handleResult(false); // Tempo scaduto
                    }
                }, 100);
                timerRef.current = interval;
            };

            const handleTap = (val) => {
                if(phase !== 'decision') return;
                clearInterval(timerRef.current);
                const max = Math.max(...options);
                handleResult(val === max);
            };

            const handleResult = (success) => {
                setPhase('result');
                if(success) {
                    setAnim('jumping');
                    setScore(s => s + (10*difficulty));
                } else {
                    setAnim('stumbling');
                }

                // Dopo animazione (1s), vai avanti o finisci
                setTimeout(() => {
                    if(count >= TOTAL) onComplete(score + (success ? 10*difficulty : 0));
                    else {
                        setCount(c => c + 1);
                        spawnObstacle();
                    }
                }, 1000);
            };

            return (
                <div className="flex flex-col h-full animate-enter">
                    <div className="flex justify-between text-slate-400 font-mono text-sm font-bold mb-4"><span>OSTACOLO: {count}/{TOTAL}</span><span className="text-indigo-400">PUNTI: {score}</span></div>
                    
                    <div className="runner-scene mb-6 relative">
                        {/* Timer Bar */}
                        {phase === 'decision' && (
                            <div className="absolute top-2 left-1/2 transform -translate-x-1/2 w-32 h-2 bg-slate-700 rounded-full overflow-hidden z-30">
                                <div className="h-full bg-yellow-400 transition-all duration-100 ease-linear" style={{width: `${timerW}%`}}></div>
                            </div>
                        )}

                        {/* Omino */}
                        <div className={`runner-box ${anim}`}>
                            <div className="stick-head"></div>
                            <div className="stick-torso"></div>
                            <div className="stick-limb arm-l"></div>
                            <div className="stick-limb arm-r"></div>
                            <div className="stick-limb leg-l"></div>
                            <div className="stick-limb leg-r"></div>
                        </div>

                        {/* Ostacolo */}
                        <div 
                            className="hurdle-group" 
                            style={{ 
                                right: phase === 'approach' ? '-150px' : phase === 'decision' ? '120px' : '120%', 
                                transition: phase === 'approach' ? 'right 1s linear' : phase === 'result' ? 'right 0.5s linear' : 'none'
                            }}
                        >
                            <div className="hurdle-nums">
                                {options.map((n, i) => (
                                    <button 
                                        key={i} 
                                        onClick={() => handleTap(n)}
                                        disabled={phase !== 'decision'}
                                        className="bg-indigo-600 text-white font-bold w-10 h-10 rounded-full border-2 border-white shadow-lg active:scale-90"
                                    >
                                        {n}
                                    </button>
                                ))}
                            </div>
                            <div className="hurdle-wall"></div>
                        </div>

                        <div className="track"></div>
                    </div>
                    <div className="text-center text-slate-400 font-bold">
                        {phase === 'decision' ? "Scegli il più alto!" : phase === 'result' ? (anim==='jumping'?"SALTO!":"INCIAMPATO!") : "In corsa..."}
                    </div>
                </div>
            );
        };

        // --- App ---
        const App = () => {
            const [user, setUser] = useLocalStorage('cortex_user', {xp:0, level:1, streak:0, last:null});
            const [view, setView] = useState('home');
            const [game, setGame] = useState(null);
            const [queue, setQueue] = useState([]);
            const [sXp, setSXp] = useState(0);

            useEffect(() => {
                const t = new Date().toDateString();
                if(user.last && user.last !== t) {
                    const y = new Date(); y.setDate(y.getDate()-1);
                    if(user.last !== y.toDateString()) setUser({...user, streak:0});
                }
            }, []);

            const next = (xp) => {
                const nx = sXp + xp; setSXp(nx);
                const rem = queue.slice(1);
                if(rem.length>0) { setQueue(rem); setGame(rem[0]); }
                else {
                    const t = new Date().toDateString();
                    const b = user.last !== t ? 1 : 0;
                    const fx = user.xp + nx;
                    setUser({...user, xp:fx, level:Math.floor(fx/1000)+1, streak:user.streak+b, last:t});
                    setView('reward');
                }
            };

            const Reward = () => {
                const cvs = useRef(null);
                useEffect(()=>{
                    const ctx = cvs.current.getContext('2d');
                    ctx.fillStyle='#1e293b'; ctx.fillRect(0,0,300,300);
                    for(let i=0; i<20; i++){
                        ctx.beginPath(); ctx.strokeStyle=`hsl(${Math.random()*360},70%,60%)`;
                        ctx.moveTo(Math.random()*300, Math.random()*300);
                        ctx.lineTo(Math.random()*300, Math.random()*300);
                        ctx.stroke();
                    }
                },[]);
                return (
                    <div className="flex flex-col items-center justify-center h-full animate-enter p-6">
                        <h2 className="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-purple-400 mb-4">Ottimo!</h2>
                        <div className="text-slate-400 mb-6">+{sXp} XP</div>
                        <canvas ref={cvs} width="300" height="300" className="rounded-xl shadow-2xl mb-6 bg-slate-800"></canvas>
                        <button onClick={()=>setView('home')} className="bg-indigo-600 text-white py-4 px-8 rounded-xl font-bold shadow-lg">Home</button>
                    </div>
                );
            };

            return (
                <div className="max-w-md mx-auto min-h-screen p-4 flex flex-col">
                    {view==='home' && (
                        <div className="animate-enter space-y-6">
                            <div className="flex justify-between items-end mt-4">
                                <div><h1 className="text-3xl font-black">Cortex<span className="text-indigo-500">Flow</span></h1><p className="text-slate-400 text-sm">Liv. {user.level} • {user.xp} XP</p></div>
                                <div className="text-center"><div className="text-2xl font-bold text-yellow-500 flex items-center gap-1"><Icon name="flame" size={24} color="#eab308"/>{user.streak}</div><div className="text-[10px] uppercase text-slate-500 font-bold">Streak</div></div>
                            </div>
                            <Card><div className="text-sm font-bold text-slate-400 mb-2">PROGRESSO</div><div className="h-3 bg-slate-900 rounded-full overflow-hidden"><div className="h-full bg-indigo-500 transition-all duration-1000" style={{width: `${(user.xp%1000)/10}%`}}></div></div></Card>
                            <button onClick={()=>{setQueue(['math','mem','logic','run']); setSXp(0); setGame('math'); setView('game');}} className="w-full bg-gradient-to-r from-indigo-600 to-purple-600 p-6 rounded-2xl flex items-center justify-between shadow-lg btn-press">
                                <div className="text-left"><div className="text-xl font-bold text-white flex gap-2"><Icon name="dumbbell" className="text-white"/> Daily Workout</div><div className="text-indigo-200 text-sm mt-1">5 Minuti</div></div>
                                <div className="bg-white/20 p-3 rounded-full"><Icon name="play" color="white"/></div>
                            </button>
                            <div className="grid grid-cols-2 gap-3">
                                {[{id:'math',n:'Calcoli Rapidi',i:'calculator',c:'text-cyan-400'},
                                  {id:'mem',n:'Synapse Seq',i:'grid',c:'text-purple-400'},
                                  {id:'logic',n:'House of Cortex',i:'home',c:'text-orange-400'},
                                  {id:'run',n:'Digit Runner',i:'activity',c:'text-green-400'}
                                ].map(g=>
                                    <button key={g.id} onClick={()=>{setQueue([]); setGame(g.id); setView('game');}} className="bg-slate-800 border border-slate-700 p-4 rounded-xl text-left btn-press"><Icon name={g.i} className={`mb-3 ${g.c}`}/><div className="font-bold text-sm">{g.n}</div></button>
                                )}
                            </div>
                        </div>
                    )}
                    {view==='game' && (
                        <div className="flex-grow flex flex-col">
                            <div className="flex items-center mb-4"><button onClick={()=>setView('home')} className="p-2"><Icon name="arrow-left"/></button><span className="font-bold text-indigo-400 ml-2 uppercase text-sm tracking-wider">{game === 'math' ? 'Calcoli Rapidi' : game === 'logic' ? 'House of Cortex' : game === 'run' ? 'Digit Runner' : 'Synapse Seq'}</span></div>
                            {game==='math' && <MathGame difficulty={Math.ceil(user.level/5)} onComplete={next}/>}
                            {game==='mem' && <MemoryGame difficulty={Math.ceil(user.level/5)} onComplete={next}/>}
                            {game==='logic' && <LogicGame difficulty={Math.ceil(user.level/5)} onComplete={next}/>}
                            {game==='run' && <RunnerGame difficulty={Math.ceil(user.level/5)} onComplete={next}/>}
                        </div>
                    )}
                    {view==='reward' && <Reward/>}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
