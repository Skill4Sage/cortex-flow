import React, { useState, useEffect, useRef } from 'react';
import { 
  Dumbbell, 
  Calculator, 
  Grid, 
  Home, 
  Flame, 
  ArrowLeft, 
  Sparkles, 
  Download, 
  Bell, 
  Play,
  Heart, 
  Zap, 
  Star, 
  Moon, 
  Sun, 
  Cloud, 
  Anchor, 
  Music 
} from 'lucide-react';

// --- DATABASE LOCALE ---
const useLocalStorage = (key, initialValue) => {
  const [storedValue, setStoredValue] = useState(() => {
    try {
      if (typeof window === "undefined") return initialValue;
      const item = window.localStorage.getItem(key);
      return item ? JSON.parse(item) : initialValue;
    } catch (error) {
      console.error(error);
      return initialValue;
    }
  });

  const setValue = (value) => {
    try {
      const valueToStore = value instanceof Function ? value(storedValue) : value;
      setStoredValue(valueToStore);
      if (typeof window !== "undefined") {
        window.localStorage.setItem(key, JSON.stringify(valueToStore));
      }
    } catch (error) {
      console.error(error);
    }
  };
  return [storedValue, setValue];
};

// --- COMPONENTI UI CONDIVISI ---
const Button = ({ children, onClick, variant = "primary", className = "", disabled = false }) => {
  const baseStyle = "w-full py-4 rounded-xl font-bold text-lg transition-all active:scale-95 flex items-center justify-center gap-2";
  const variants = {
    primary: "bg-indigo-600 hover:bg-indigo-500 text-white shadow-lg shadow-indigo-900/50",
    secondary: "bg-slate-700 hover:bg-slate-600 text-white",
    outline: "border-2 border-slate-600 text-slate-300 hover:border-slate-400",
    danger: "bg-red-500/20 text-red-400 border border-red-500/50"
  };
  return (
    <button 
      onClick={onClick} 
      disabled={disabled}
      className={`${baseStyle} ${variants[variant]} ${disabled ? 'opacity-50 cursor-not-allowed' : ''} ${className}`}
    >
      {children}
    </button>
  );
};

const Card = ({ children, className = "" }) => (
  <div className={`bg-slate-800/80 backdrop-blur-md border border-slate-700/50 rounded-2xl p-6 ${className}`}>
    {children}
  </div>
);

// --- LOGICA GIOCO: NEURO-CALCOLO ---
const MathGame = ({ onComplete, difficulty }) => {
  const [problem, setProblem] = useState({ q: "", a: 0 });
  const [input, setInput] = useState("");
  const [score, setScore] = useState(0);
  const [timeLeft, setTimeLeft] = useState(60);
  const [feedback, setFeedback] = useState(null); 

  const generateProblem = () => {
    const types = ['+', '-', '*'];
    // Niente moltiplicazioni a liv 1
    const type = types[Math.floor(Math.random() * (difficulty > 1 ? 3 : 2))]; 
    let n1, n2;

    const rnd = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

    if (difficulty === 1) { n1 = rnd(1, 20); n2 = rnd(1, 20); }
    else if (difficulty === 2) { n1 = rnd(10, 50); n2 = rnd(5, 50); }
    else { n1 = rnd(10, 99); n2 = rnd(2, 9); } 

    if (type === '-') {
      if (n1 < n2) [n1, n2] = [n2, n1]; 
    }

    let ans;
    switch(type) {
      case '+': ans = n1 + n2; break;
      case '-': ans = n1 - n2; break;
      case '*': ans = n1 * n2; break;
      default: ans = 0;
    }
    setProblem({ q: `${n1} ${type} ${n2}`, a: ans });
  };

  useEffect(() => { generateProblem(); }, []);

  useEffect(() => {
    if (timeLeft > 0) {
      const timer = setTimeout(() => setTimeLeft(timeLeft - 1), 1000);
      return () => clearTimeout(timer);
    } else {
      onComplete(score);
    }
  }, [timeLeft]);

  const handleInput = (num) => {
    if (feedback) return;
    setInput(prev => prev + num);
  };

  const submit = () => {
    if (parseInt(input) === problem.a) {
      setScore(score + 10 + (difficulty * 5));
      setFeedback('correct');
      setTimeout(() => {
        setFeedback(null);
        setInput("");
        generateProblem();
      }, 300);
    } else {
      setFeedback('wrong');
      setTimeout(() => {
        setFeedback(null);
        setInput("");
      }, 300);
    }
  };

  const clear = () => setInput("");

  return (
    <div className="flex flex-col h-full animate-enter">
      <div className="flex justify-between items-center mb-4">
        <span className="text-slate-400 font-mono">Tempo: {timeLeft}s</span>
        <span className="text-indigo-400 font-bold">Punti: {score}</span>
      </div>
      
      <Card className={`mb-4 flex-grow flex items-center justify-center transition-colors duration-200 ${feedback === 'correct' ? 'bg-green-900/30 border-green-500' : feedback === 'wrong' ? 'bg-red-900/30 border-red-500' : ''}`}>
        <div className="text-center">
          <div className="text-5xl font-mono font-bold mb-4">{problem.q}</div>
          <div className="text-4xl text-indigo-300 min-h-[3rem]">{input || "?"}</div>
        </div>
      </Card>

      <div className="grid grid-cols-3 gap-3">
        {[1, 2, 3, 4, 5, 6, 7, 8, 9].map(n => (
          <button key={n} onClick={() => handleInput(n)} className="bg-slate-700 py-4 rounded-xl text-2xl font-bold active:bg-slate-600 transition-colors hover:bg-slate-600 text-white shadow-md">{n}</button>
        ))}
        <button onClick={clear} className="bg-red-900/50 text-red-300 py-4 rounded-xl text-xl font-bold hover:bg-red-900/70 transition-colors">C</button>
        <button onClick={() => handleInput(0)} className="bg-slate-700 py-4 rounded-xl text-2xl font-bold active:bg-slate-600 transition-colors hover:bg-slate-600 text-white shadow-md">0</button>
        <button onClick={submit} className="bg-green-600 text-white py-4 rounded-xl text-xl font-bold hover:bg-green-500 transition-colors shadow-lg shadow-green-900/50">OK</button>
      </div>
    </div>
  );
};

// --- LOGICA GIOCO: CORTEX HOUSE (Attenzione) ---
const LogicGame = ({ onComplete, difficulty }) => {
  const [stage, setStage] = useState('watch');
  const [peopleInside, setPeopleInside] = useState(0);
  const [animationText, setAnimationText] = useState("La casa √® vuota");
  const [userAnswer, setUserAnswer] = useState("");
  
  const eventsCount = difficulty === 1 ? 5 : difficulty === 2 ? 8 : 12;
  const speed = difficulty === 1 ? 2000 : difficulty === 2 ? 1500 : 1000;

  useEffect(() => {
    let currentPeople = 0;
    let events = [];
    
    for(let i=0; i<eventsCount; i++) {
      const isEnter = Math.random() > 0.3 || currentPeople === 0;
      const amount = Math.floor(Math.random() * 3) + 1;
      
      if (isEnter) {
        currentPeople += amount;
        events.push({ type: 'in', amount });
      } else {
        const realAmount = Math.min(amount, currentPeople);
        currentPeople -= realAmount;
        events.push({ type: 'out', amount: realAmount });
      }
    }
    setPeopleInside(currentPeople);

    let eventIndex = 0;
    const interval = setInterval(() => {
      if (eventIndex >= events.length) {
        clearInterval(interval);
        setStage('answer');
        return;
      }
      
      const ev = events[eventIndex];
      if (ev.type === 'in') {
        setAnimationText(`üö™ +${ev.amount} Entrano`);
      } else {
        setAnimationText(`üèÉ -${ev.amount} Escono`);
      }
      eventIndex++;
    }, speed);

    return () => clearInterval(interval);
  }, [difficulty]);

  const submit = () => {
    if (parseInt(userAnswer) === peopleInside) {
      onComplete(100 * difficulty);
    } else {
      onComplete(0);
    }
  };

  if (stage === 'watch') {
    return (
      <div className="flex flex-col items-center justify-center h-full animate-enter">
        <div className="text-6xl mb-8">üè†</div>
        <div className="text-2xl font-bold animate-pulse text-indigo-300 text-center">{animationText}</div>
        <p className="mt-8 text-slate-500">Osserva attentamente...</p>
      </div>
    );
  }

  return (
    <div className="flex flex-col h-full animate-enter">
      <h2 className="text-xl text-center mb-6 text-slate-200">Quante persone sono rimaste?</h2>
      <div className="text-5xl text-center font-bold text-indigo-400 mb-8 min-h-[4rem]">
        {userAnswer}
      </div>
      <div className="grid grid-cols-3 gap-3 mt-auto">
        {[1, 2, 3, 4, 5, 6, 7, 8, 9, 0].map(n => (
          <button key={n} onClick={() => setUserAnswer(prev => prev + n)} className="bg-slate-700 py-4 rounded-xl text-2xl font-bold text-white hover:bg-slate-600 transition-colors">{n}</button>
        ))}
        <button onClick={() => setUserAnswer("")} className="bg-red-900/50 text-red-300 py-4 rounded-xl font-bold hover:bg-red-900/70 transition-colors">C</button>
        <button onClick={submit} className="bg-green-600 text-white py-4 rounded-xl font-bold col-span-3 hover:bg-green-500 transition-colors shadow-lg shadow-green-900/50">CONFERMA</button>
      </div>
    </div>
  );
};

// --- LOGICA GIOCO: SYNAPSE SEQUENCE (Memoria) ---
const MemoryGame = ({ onComplete, difficulty }) => {
  const iconComponents = {
    heart: Heart,
    zap: Zap,
    star: Star,
    moon: Moon,
    sun: Sun,
    cloud: Cloud,
    anchor: Anchor,
    music: Music
  };
  const iconsPool = Object.keys(iconComponents);

  const [sequence, setSequence] = useState([]);
  const [playerSequence, setPlayerSequence] = useState([]);
  const [isShowing, setIsShowing] = useState(true);
  const [level, setLevel] = useState(1);

  const startLevel = (currentLvl) => {
    setPlayerSequence([]);
    setIsShowing(true);
    const newSeq = [];
    const count = 2 + currentLvl; 
    for(let i=0; i<count; i++) {
      newSeq.push(iconsPool[Math.floor(Math.random() * iconsPool.length)]);
    }
    setSequence(newSeq);

    setTimeout(() => {
      setIsShowing(false);
    }, 1000 + (count * 800));
  };

  useEffect(() => { startLevel(level); }, []);

  const handleClick = (iconName) => {
    if (isShowing) return;
    
    const nextIdx = playerSequence.length;
    if (iconName !== sequence[nextIdx]) {
      // Errore
      onComplete((level - 1) * 50);
      return;
    }

    const newPlayerSeq = [...playerSequence, iconName];
    setPlayerSequence(newPlayerSeq);

    if (newPlayerSeq.length === sequence.length) {
      // Livello completato
      if (level >= (difficulty * 2) + 2) { 
        onComplete(level * 100);
      } else {
        setTimeout(() => {
          setLevel(l => l + 1);
          startLevel(level + 1);
        }, 500);
      }
    }
  };

  return (
    <div className="h-full flex flex-col items-center animate-enter">
      <div className="mb-4 text-slate-400">Livello {level}</div>
      
      <div className="flex-grow flex items-center justify-center w-full">
        {isShowing ? (
          <div className="flex gap-4 flex-wrap justify-center">
            {sequence.map((icon, idx) => {
              const IconComp = iconComponents[icon];
              return (
                <div key={idx} className="animate-enter" style={{animationDelay: `${idx * 0.5}s`}}>
                  <Card className="p-4 bg-indigo-900/40 border-indigo-500 shadow-indigo-500/20 shadow-lg">
                    <IconComp size={48} color="#818cf8" />
                  </Card>
                </div>
              );
            })}
          </div>
        ) : (
          <div className="text-2xl font-bold text-slate-300 animate-pulse">Ripeti la sequenza!</div>
        )}
      </div>

      <div className="grid grid-cols-4 gap-4 mt-auto w-full">
        {iconsPool.map(icon => {
          const IconComp = iconComponents[icon];
          return (
            <button 
              key={icon}
              disabled={isShowing}
              onClick={() => handleClick(icon)}
              className="bg-slate-700 p-4 rounded-xl flex items-center justify-center active:bg-indigo-600 disabled:opacity-30 disabled:cursor-not-allowed hover:bg-slate-600 transition-colors"
            >
              <IconComp size={32} className="text-white" />
            </button>
          );
        })}
      </div>
    </div>
  );
};

// --- SISTEMA AI ART REWARD ---
const DailyReward = ({ onClose }) => {
  const canvasRef = useRef(null);
  const [quote, setQuote] = useState("");

  const quotes = [
    "Il genio √® l'1% di talento e il 99% di duro lavoro. - Einstein",
    "Imparare senza pensare √® fatica persa. - Confucio",
    "La mente √® come un paracadute. Funziona solo se si apre. - Frank Zappa",
    "Sii la versione migliore di te stesso.",
    "Ogni errore √® un passo verso la saggezza."
  ];

  useEffect(() => {
    setQuote(quotes[Math.floor(Math.random() * quotes.length)]);
    
    if (canvasRef.current) {
      const cvs = canvasRef.current;
      const ctx = cvs.getContext('2d');
      const w = cvs.width = 300;
      const h = cvs.height = 300;

      // Sfondo scuro
      ctx.fillStyle = '#0f172a';
      ctx.fillRect(0, 0, w, h);

      // Algoritmo generativo "Neural Web"
      ctx.lineWidth = 1;
      for(let i=0; i<30; i++) {
        ctx.beginPath();
        ctx.strokeStyle = `hsla(${Math.random() * 360}, 70%, 60%, 0.6)`;
        ctx.moveTo(Math.random() * w, Math.random() * h);
        ctx.bezierCurveTo(
          Math.random() * w, Math.random() * h,
          Math.random() * w, Math.random() * h,
          Math.random() * w, Math.random() * h
        );
        ctx.stroke();
      }

      // Cerchi concentrici "Sinapsi"
      for(let i=0; i<5; i++) {
        ctx.beginPath();
        ctx.fillStyle = `hsla(${Math.random() * 360}, 80%, 70%, 0.3)`;
        ctx.arc(Math.random() * w, Math.random() * h, Math.random() * 50, 0, Math.PI * 2);
        ctx.fill();
      }
    }
  }, []);

  const saveImage = () => {
    if (canvasRef.current) {
        const link = document.createElement('a');
        link.download = `CortexArt_${new Date().toISOString().slice(0,10)}.png`;
        link.href = canvasRef.current.toDataURL();
        link.click();
    }
  };

  return (
    <div className="fixed inset-0 bg-black/90 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-in fade-in duration-300">
      <div className="bg-slate-800 rounded-2xl p-6 max-w-sm w-full text-center border border-indigo-500/50 shadow-2xl shadow-indigo-500/20">
        <div className="flex justify-center mb-2">
          <Sparkles color="#fbbf24" size={32} />
        </div>
        <h2 className="text-2xl font-bold bg-gradient-to-r from-indigo-400 to-purple-400 bg-clip-text text-transparent mb-2">
          Ispirazione Quotidiana
        </h2>
        <p className="text-slate-400 text-sm mb-4">Generato dalla tua attivit√† neurale</p>
        
        <canvas ref={canvasRef} width={300} height={300} className="mx-auto mb-4 w-64 h-64 rounded-xl shadow-lg"></canvas>
        
        <p className="italic text-slate-300 font-serif mb-6 border-l-2 border-indigo-500 pl-4 text-left">"{quote}"</p>
        
        <div className="flex gap-2">
            <Button onClick={saveImage} variant="secondary" className="mb-2 text-sm py-2">
            <Download size={18} /> Salva
            </Button>
            <Button onClick={onClose} variant="primary">Chiudi</Button>
        </div>
      </div>
    </div>
  );
};

// --- DASHBOARD PRINCIPALE ---
const Dashboard = ({ user, startTraining, openGame }) => {
  const [notificationTime, setNotificationTime] = useLocalStorage("cortexNotification", "09:00");

  const setReminder = () => {
    if ("Notification" in window && Notification.permission !== "granted") {
      Notification.requestPermission();
    }
    alert(`Promemoria impostato per le ${notificationTime}. Sii costante!`);
  };

  return (
    <div className="space-y-6 pb-20 animate-enter">
      {/* Header Utente */}
      <div className="flex justify-between items-end">
        <div>
          <h1 className="text-3xl font-extrabold tracking-tight text-white">Cortex<span className="text-indigo-500">Flow</span></h1>
          <p className="text-slate-400 text-sm">Bentornato, Atleta della Mente.</p>
        </div>
        <div className="text-center bg-slate-800 p-2 rounded-lg border border-slate-700">
          <div className="text-2xl font-bold text-yellow-500 flex items-center gap-1 justify-center">
            <Flame size={24} fill="#eab308" /> {user.streak}
          </div>
          <div className="text-xs text-slate-500 uppercase tracking-wide">Streak</div>
        </div>
      </div>

      {/* Livello XP */}
      <Card>
        <div className="flex justify-between mb-2 text-sm">
          <span className="font-bold text-indigo-300">Livello {user.level}</span>
          <span className="text-slate-400">{user.xp} / {user.level * 1000} XP</span>
        </div>
        <div className="w-full bg-slate-900 rounded-full h-3 overflow-hidden shadow-inner">
          <div className="bg-gradient-to-r from-indigo-600 to-purple-500 h-3 rounded-full transition-all duration-1000" style={{ width: `${Math.min((user.xp / (user.level * 1000)) * 100, 100)}%` }}></div>
        </div>
      </Card>

      {/* Allenamento Quotidiano */}
      <div className="relative group">
        <div className="absolute -inset-0.5 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-2xl blur opacity-60 group-hover:opacity-100 transition duration-1000 group-hover:duration-200 animate-pulse"></div>
        <button onClick={startTraining} className="relative w-full bg-slate-900 rounded-2xl p-6 flex items-center justify-between border border-slate-700 hover:bg-slate-800 transition-colors">
          <div className="text-left">
            <h3 className="text-xl font-bold text-white flex items-center gap-2">
              <Dumbbell className="text-indigo-400"/> Daily Workout
            </h3>
            <p className="text-slate-400 text-sm mt-1 font-medium">5 Minuti ‚Ä¢ 3 Esercizi</p>
          </div>
          <div className="bg-indigo-600 rounded-full p-3 shadow-lg shadow-indigo-900/50">
            <Play color="white" fill="white" size={20} />
          </div>
        </button>
      </div>

      {/* Griglia Giochi Singoli */}
      <div>
        <h3 className="text-lg font-bold mb-3 text-slate-300 pl-1">Allenamento Libero</h3>
        <div className="grid grid-cols-2 gap-4">
          <button onClick={() => openGame('math')} className="bg-slate-800 p-4 rounded-xl border border-slate-700 hover:border-indigo-500 transition-colors text-left hover:bg-slate-750 group">
            <div className="bg-slate-900/50 w-10 h-10 rounded-lg flex items-center justify-center mb-3 group-hover:bg-cyan-900/30 transition-colors">
                <Calculator className="text-cyan-400" size={20} />
            </div>
            <div className="font-bold text-slate-200">Neuro Calcolo</div>
          </button>
          <button onClick={() => openGame('memory')} className="bg-slate-800 p-4 rounded-xl border border-slate-700 hover:border-purple-500 transition-colors text-left hover:bg-slate-750 group">
            <div className="bg-slate-900/50 w-10 h-10 rounded-lg flex items-center justify-center mb-3 group-hover:bg-purple-900/30 transition-colors">
                <Grid className="text-purple-400" size={20} />
            </div>
            <div className="font-bold text-slate-200">Synapse Seq</div>
          </button>
          <button onClick={() => openGame('logic')} className="bg-slate-800 p-4 rounded-xl border border-slate-700 hover:border-orange-500 transition-colors text-left hover:bg-slate-750 group">
            <div className="bg-slate-900/50 w-10 h-10 rounded-lg flex items-center justify-center mb-3 group-hover:bg-orange-900/30 transition-colors">
                <Home className="text-orange-400" size={20} />
            </div>
            <div className="font-bold text-slate-200">Cortex House</div>
          </button>
        </div>
      </div>

      {/* Impostazioni Rapide */}
      <Card className="flex items-center justify-between py-4">
        <div className="flex items-center gap-3">
          <Bell className="text-slate-400" />
          <div className="flex flex-col">
            <span className="font-bold text-sm text-slate-200">Promemoria</span>
            <input 
              type="time" 
              value={notificationTime}
              onChange={(e) => setNotificationTime(e.target.value)}
              className="bg-transparent text-slate-400 text-xs border-none p-0 focus:ring-0 cursor-pointer"
            />
          </div>
        </div>
        <button onClick={setReminder} className="text-indigo-400 text-sm font-bold hover:text-indigo-300">Salva</button>
      </Card>
    </div>
  );
};

// --- APP CONTAINER ---
export default function App() {
  const [user, setUser] = useLocalStorage("cortexUser", {
    xp: 0,
    level: 1,
    streak: 0,
    lastPlayed: null
  });

  const [view, setView] = useState("home"); // home, game, result
  const [activeGame, setActiveGame] = useState(null);
  const [sessionScore, setSessionScore] = useState(0);
  const [isDaily, setIsDaily] = useState(false);
  const [dailyQueue, setDailyQueue] = useState([]); // coda giochi daily
  const [showReward, setShowReward] = useState(false);

  useEffect(() => {
    // Controllo Streak
    if (typeof window !== "undefined") {
      const today = new Date().toDateString();
      if (user.lastPlayed !== today) {
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        if (user.lastPlayed !== yesterday.toDateString()) {
          // Reset streak se saltato un giorno (ma non se √® la prima volta)
          if (user.lastPlayed) setUser(u => ({ ...u, streak: 0 }));
        }
      }
    }
  }, []);

  const startDaily = () => {
    setIsDaily(true);
    setDailyQueue(['math', 'memory', 'logic']);
    setSessionScore(0);
    setActiveGame('math'); // Inizia col primo
    setView('game');
  };

  const startGame = (type) => {
    setIsDaily(false);
    setActiveGame(type);
    setSessionScore(0);
    setView('game');
  };

  const handleGameComplete = (score) => {
    const newScore = sessionScore + score;
    setSessionScore(newScore);

    if (isDaily) {
      const remaining = dailyQueue.slice(1);
      if (remaining.length > 0) {
        setDailyQueue(remaining);
        setActiveGame(remaining[0]); 
      } else {
        finishSession(newScore, true);
      }
    } else {
      finishSession(newScore, false);
    }
  };

  const finishSession = (finalScore, isDailyComplete) => {
    const today = new Date().toDateString();
    let newStreak = user.streak;
    
    if (isDailyComplete && user.lastPlayed !== today) {
      newStreak += 1;
    }

    let newXp = user.xp + finalScore;
    let newLevel = user.level;
    // Logica Level Up
    if (newXp >= newLevel * 1000) {
      newXp = newXp - (newLevel * 1000);
      newLevel++;
    }

    setUser({
      ...user,
      xp: newXp,
      level: newLevel,
      streak: newStreak,
      lastPlayed: isDailyComplete ? today : user.lastPlayed
    });

    setView('result');
    if (isDailyComplete) {
      setTimeout(() => setShowReward(true), 1500); 
    }
  };

  const goHome = () => setView("home");

  return (
    <div className="max-w-md mx-auto min-h-screen bg-slate-900 p-4 flex flex-col font-sans text-slate-100 selection:bg-indigo-500 selection:text-white">
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-enter { animation: fadeIn 0.3s ease-out; }
      `}</style>

      {view === "home" && (
        <Dashboard user={user} startTraining={startDaily} openGame={startGame} />
      )}

      {view === "game" && (
        <div className="flex-grow flex flex-col">
          <div className="flex justify-between mb-4 items-center">
            <button onClick={goHome} className="text-slate-400 hover:text-white transition-colors p-2 rounded-full hover:bg-slate-800"><ArrowLeft size={24} /></button>
            <span className="font-bold text-indigo-400 uppercase tracking-widest text-sm bg-slate-800 px-3 py-1 rounded-full border border-slate-700">
              {activeGame === 'math' ? 'Neuro Calcolo' : activeGame === 'memory' ? 'Synapse Seq' : 'Cortex House'}
            </span>
            <div className="w-10"></div>
          </div>
          
          {activeGame === 'math' && <MathGame difficulty={Math.ceil(user.level / 5)} onComplete={handleGameComplete} />}
          {activeGame === 'memory' && <MemoryGame difficulty={Math.ceil(user.level / 5)} onComplete={handleGameComplete} />}
          {activeGame === 'logic' && <LogicGame difficulty={Math.ceil(user.level / 5)} onComplete={handleGameComplete} />}
        </div>
      )}

      {view === "result" && (
        <div className="flex flex-col items-center justify-center flex-grow animate-enter">
          <h2 className="text-3xl font-bold mb-2 text-white">Sessione Terminata</h2>
          <div className="text-6xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-purple-500 mb-6 drop-shadow-2xl">+{sessionScore} XP</div>
          
          <Card className="w-full mb-8 border-indigo-500/30">
            <div className="text-center">
              <div className="text-slate-400 mb-2 font-medium">Progressi verso Livello {user.level + 1}</div>
              <div className="w-full bg-slate-900 rounded-full h-4 overflow-hidden border border-slate-700">
                <div className="bg-gradient-to-r from-indigo-500 to-purple-500 h-4 rounded-full transition-all duration-1000 shadow-[0_0_15px_rgba(99,102,241,0.5)]" style={{ width: `${(user.xp / (user.level * 1000)) * 100}%` }}></div>
              </div>
            </div>
          </Card>

          <Button onClick={goHome} variant="primary">Torna alla Home</Button>
        </div>
      )}

      {showReward && (
        <DailyReward onClose={() => { setShowReward(false); goHome(); }} />
      )}
    </div>
  );
}
